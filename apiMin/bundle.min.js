var AV=require("leanengine"),requestJS=require("request");async function getQiniuJSON(e){var t=e.params.fileNameArr,a=await AV.Cloud.run("getShimoTokenRaw");return new Promise((e,n)=>{requestJS.post(`https://uploader.shimo.im/token?server=qiniu&type=attachments&accessToken=${a}`,{json:!0,body:t},(t,a,i)=>{t?n(!1):e(i)})})}AV.Cloud.define("getQiniuJSON",async function(e){return await getQiniuJSON(e)});requestJS=require("request");function getShimoTokenRaw(e){return new Promise((e,t)=>{requestJS.post("https://shimo.im/api/upload/token",{json:!0,headers:{Cookie:process.env.shimoCookie}},(a,n,i)=>{if(a)t(!1);else{var o=i.data.accessToken.toString();e(o)}})})}AV.Cloud.define("getShimoTokenRaw",async function(e){return await getShimoTokenRaw(e)});var http=require("request");async function postFormShimo(e){var t=await AV.Cloud.run("getShimoTokenRaw"),a=e.params.data,n=e.params.filename;return new Promise((i,o)=>{const s=http.post({url:"https://uploader.shimo.im/upload2"},function(t,a,o){var s=JSON.parse(o),r=n.split("."),c=r.pop(),u=r.join(".");s.data.type=c,s.data.name=u,s.class=e.params.class,s.lottieURL=e.params.lottieURL;var p=AV.Cloud.run("updateShimo",s);i(p)}).form();s.append("server","qiniu"),s.append("type","attachments"),s.append("accessToken",t),s.append("file",a,{filename:n})})}function save2LeanCloud(e){var t=e.params,a=new(AV.Object.extend(t.chosenClass));for(var n in t)a.set(n,t[n]);a.save().then(function(){},function(e){})}AV.Cloud.define("postFormShimo",async function(e){return await postFormShimo(e)}),AV.Cloud.define("save2LeanCloud",async function(e){return await save2LeanCloud(e)});var axios=require("axios");const Qs=require("qs");var fs=require("fs"),request=require("request"),newDiscussionID="K8CWmBMqMtYYpU1f",getAttachmentID="K8CWmBMqMtYYpU1f",shimoCookie=process.env.shimoCookie,genericHeaders={Accept:"application/vnd.shimo.v2+json","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Authorization:"Bearer 62cbbe058449d3db514c7aece09afe0c13d0e501ed07624478704405d6cef617200823a164c086b87153edbba7acabcbc78c475c53a19a89df10cc2f872855a8","Cache-Control":"no-cache",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 12_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16B92",Cookie:shimoCookie};async function tryCatch(e){try{return[await e,null]}catch(e){return[null,e]}}function http(e){return tryCatch(axios.create({transformRequest:[e=>Qs.stringify(e)]})(e))}function KB2GB(e){return(e/1073741824).toFixed(2)}async function getDiscussion(e){var t,a=[],n={Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Referer:"https://shimo.im/docs/K8CWmBMqMtYYpU1f","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.1 Safari/605.1.15","X-CSRF-Token":"JDvV3azC-fmyRaI4kR98csJiXEhmprm78WMw",Cookie:shimoCookie+"_csrf=q4MNRquXrxATGBLCwExHVcIs;"};const[i,o]=await http({method:"get",url:`https://shimo.im/smapi/files/${e}/discussions?limit=99999999`,headers:n});if(!o){for(var s in t=i.data.data.list){var r=t[s];a.push(r.data.content)}return a}}async function getAttachment(e){var t="https://api.shimo.im/files/"+e+"?content=true";const[a,n]=await http({method:"get",url:t,headers:genericHeaders});if(!n){var i=[],o=a.data.content;o=JSON.parse(o);for(var s=0;s<o.length;s++){var r=o[s][1].attachment;r&&i.push(r)}return i}}async function postDiscussion(e,t){const[a,n]=await http({method:"post",url:"https://shimo.im/smapi/files/"+e+"/discussions",headers:{Cookie:shimoCookie},data:{content:t}});if(!n)return 0!==a.data.code?"error":a.data}async function shortenURL(e){var t=e.match(/[a-zA-z]+:\/\/[^\s]*/g);for(i=0;i<t.length;i++){var a="http://api.weibo.com/2/short_url/shorten.json?source=2849184197&url_long="+encodeURIComponent(t[i]),n=(await axios.get(a)).data.urls[0].url_short;e=e.replace(t[i],n)}return e}function cutHTTP(e){return e.replace(/[a-zA-z]+:\/\//g,"")}async function googleTranslateByPost(e){try{var t,a=await axios({method:"POST",url:"http://translate.google.cn/translate_a/single",params:{dt:"t",q:e,tl:"zh-CN",ie:"UTF-8",sl:"auto",client:"ia",dj:"1"},headers:{Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Cookie:"NID=154=Vf6msfWVov9Icm1WMYfq3dQ3BGHUlq6Txh5RHjnBtN48ZIZAdE_iQjxrrOMsOhbRlXXHtReYEm1rRKGUD3WsP1DhA0sO0nDf5S-J69qEBYRzIAY8nd1cE20wAKOr3cXxxPgwN12Dc5ly07v-F7RY-6Uv3ldkWGYeXWTgwkPR6Cs",Host:"translate.google.cn","User-Agent":"GoogleTranslate/5.26.59113 (iPhone; iOS 12.1; zh_CN; iPhone10,3)"}}),n="",i=a.data.sentences;if(i.length>1)for(t=0;t<i.length;++t)n+=i[t].trans+"\n";else n=i[0].trans;return n}catch(t){return e}}function emoji(e){return e.match(/[a-zA-Z]/g)?e.match(/mp4|mov|avi/gi)?"ðŸŽ¬":e.match(/webm|mkv|avi/gi)?"â–¶ï¸":e.match(/mp3|ogg|wav|flac|ape|alca|aac/gi)?"ðŸŽµ":e.match(/zip|7z|rar/gi)?"ðŸ“¦":e.match(/dmg|iso/gi)?"ðŸ’½":e.match(/ai|psd|aep/gi)?"ðŸ“":e.match(/ppt|pptx|key/gi)?"ðŸ“½ï¸":e.match(/ttf|otf/gi)?"ðŸ”¤ï¸":e.match(/doc|pdf/gi)?"ï¸ðŸ“„":"â“":e}async function update(e,t){var a,n,i=[],o=await getDiscussion(e);o.length;for(var s in n=await getAttachment(t),a=0!=o.length?o.join("\n"):"",o)o[s].match("size")&&Number(JSON.parse(o[s]).size);n.forEach(async e=>{var t=e,n=t.name.split("."),o=n.pop(),s=n.join(".");if(!a.match(t.url)){var r={type:o,name:s,size:t.size,uploaderURL:t.url},c=await save2DataBase(r);i.push(c)}});i.length;return i}async function save2DataBase(e){e.shortURL=await shortenURL(e.uploaderURL),e.name_trans=await googleTranslateByPost(e.name.toLowerCase()),content=JSON.stringify(e);var t=await postDiscussion(newDiscussionID,content);return e.id=t.data.id,e.unixus=t.data.unixus,AV.Cloud.run("save2LeanCloud",e),`${emoji(e.type)} ${e.name} | ${cutHTTP(e.shortURL)}`}async function updateShimo(e){var t;if(e&&0==e.params.code){var a=e.params.data,n=e.params.class||"ShimoBed",i={type:a.type,name:a.name,size:a.size,uploaderURL:a.url,lottieURL:e.params.lottieURL,chosenClass:n};save2DataBase(i),t=[i]}else t=await update(newDiscussionID,getAttachmentID);return t}AV.Cloud.define("updateShimo",async function(e){return await updateShimo(e)});