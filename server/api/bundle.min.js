var e=require("leanengine"),a=require("request");e.Cloud.define("getQiniuJSON",async function(t){return await async function(t){var n=t.params.fileNameArr,o=await e.Cloud.run("getShimoTokenRaw");return console.log(o),new Promise((e,t)=>{a.post(`https://uploader.shimo.im/token?server=qiniu&type=attachments&accessToken=${o}`,{json:!0,body:n},(a,n,o)=>{a?t(!1):(console.log(o),e(o))})})}(t)}),e.Cloud.define("getShimoTokenRaw",async function(e){return await new Promise((e,t)=>{a.post("https://shimo.im/api/upload/token",{json:!0,headers:{Cookie:process.env.shimoCookie}},(a,n,o)=>{if(a)t(!1);else{var i=o.data.accessToken.toString();e(i)}})})}),e.Cloud.define("postFormShimo",async function(t){return await async function(t){var n=await e.Cloud.run("getShimoTokenRaw"),o=t.params.data,i=t.params.filename;return new Promise((s,r)=>{const c=a.post({url:"https://uploader.shimo.im/upload2"},function(a,n,o){var r=JSON.parse(o),c=i.split("."),l=c.pop(),u=c.join(".");r.data.type=l,r.data.name=u,r.class=t.params.class,r.lottieURL=t.params.lottieURL;var p=e.Cloud.run("updateShimo",r);s(p)}).form();c.append("server","qiniu"),c.append("type","attachments"),c.append("accessToken",n),c.append("file",o,{filename:i})})}(t)}),e.Cloud.define("save2LeanCloud",async function(a){return await function(a){var t=a.params,n=new(e.Object.extend(t.chosenClass));for(var o in t)n.set(o,t[o]);n.save().then(function(){console.log("å·²ä¸Šä¼ åˆ°LeanCloud")},function(e){console.log(JSON.stringify(e))})}(a)}),e.Cloud.define("test",async function(e){return await"success!!!"});var t=require("axios");const n=require("qs");require("fs");var o="K8CWmBMqMtYYpU1f",s="K8CWmBMqMtYYpU1f",r=process.env.shimoCookie,c={Accept:"application/vnd.shimo.v2+json","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Authorization:"Bearer 62cbbe058449d3db514c7aece09afe0c13d0e501ed07624478704405d6cef617200823a164c086b87153edbba7acabcbc78c475c53a19a89df10cc2f872855a8","Cache-Control":"no-cache",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 12_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16B92",Cookie:r};function l(e){return async function(e){try{return[await e,null]}catch(e){return[null,e]}}(t.create({transformRequest:[e=>n.stringify(e)]})(e))}function u(e){return(e/1073741824).toFixed(2)}async function p(e,a){var t,n,o=[],i=0,s=0,p=await async function(e){var a,t=[],n={Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Referer:"https://shimo.im/docs/K8CWmBMqMtYYpU1f","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.1 Safari/605.1.15","X-CSRF-Token":"JDvV3azC-fmyRaI4kR98csJiXEhmprm78WMw",Cookie:r+"_csrf=q4MNRquXrxATGBLCwExHVcIs;"};const[o,i]=await l({method:"get",url:`https://shimo.im/smapi/files/${e}/discussions?limit=99999999`,headers:n});if(i)return console.log("getDiscussionè¯·æ±‚å‡ºé”™: "+i);for(var s in a=o.data.data.list){var c=a[s];t.push(c.data.content)}return t}(e),d=p.length;for(var h in n=await async function(e){var a="https://api.shimo.im/files/"+e+"?content=true";const[t,n]=await l({method:"get",url:a,headers:c});if(n)return console.log("getAttachmentè¯·æ±‚å‡ºé”™: "+n);var o=[],i=t.data.content;i=JSON.parse(i);for(var s=0;s<i.length;s++){var r=i[s][1].attachment;r&&o.push(r)}return o}(a),t=0!=p.length?p.join("\n"):"",p)p[h].match("size")&&(i+=Number(JSON.parse(p[h]).size));return n.forEach(async e=>{var a=e,n=a.name.split("."),i=n.pop(),s=n.join(".");if(!t.match(a.url)){var r={type:i,name:s,size:a.size,uploaderURL:a.url},c=await m(r);o.push(c)}}),0!=(s=o.length)?(console.log("å…±å¢žåŠ "+s+"ä¸ªæ–°é¡¹ç›®ï¼Œå·²ä¸Šä¼  "+(d+s)+" ä¸ªæ–‡ä»¶ï¼Œç´¯è®¡ "+u(i)+" GB"),console.log("\n"+o.join("\n")+"\n")):console.log("å·²ä¸Šä¼  "+d+" ä¸ªæ–‡ä»¶ï¼Œç´¯è®¡ "+u(i)+" GB"),o}async function m(a){a.shortURL=await async function(e){var a=e.match(/[a-zA-z]+:\/\/[^\s]*/g);for(i=0;i<a.length;i++){var n="http://api.weibo.com/2/short_url/shorten.json?source=2849184197&url_long="+encodeURIComponent(a[i]),o=(await t.get(n)).data.urls[0].url_short;e=e.replace(a[i],o)}return e}(a.uploaderURL),a.name_trans=await async function(e){try{var a,n=await t({method:"POST",url:"http://translate.google.cn/translate_a/single",params:{dt:"t",q:e,tl:"zh-CN",ie:"UTF-8",sl:"auto",client:"ia",dj:"1"},headers:{Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Cookie:"NID=154=Vf6msfWVov9Icm1WMYfq3dQ3BGHUlq6Txh5RHjnBtN48ZIZAdE_iQjxrrOMsOhbRlXXHtReYEm1rRKGUD3WsP1DhA0sO0nDf5S-J69qEBYRzIAY8nd1cE20wAKOr3cXxxPgwN12Dc5ly07v-F7RY-6Uv3ldkWGYeXWTgwkPR6Cs",Host:"translate.google.cn","User-Agent":"GoogleTranslate/5.26.59113 (iPhone; iOS 12.1; zh_CN; iPhone10,3)"}}),o="",i=n.data.sentences;if(i.length>1)for(a=0;a<i.length;++a)o+=i[a].trans+"\n";else o=i[0].trans;return console.log("è°·æ­Œç¿»è¯‘æˆåŠŸç»“æžœï¼š"+o),o}catch(a){return console.log("è°·æ­Œç¿»è¯‘å¤±è´¥"),e}}(a.name.toLowerCase()),content=JSON.stringify(a);var n,s,c=await async function(e,a){const[t,n]=await l({method:"post",url:"https://shimo.im/smapi/files/"+e+"/discussions",headers:{Cookie:r},data:{content:a}});return n?console.log("Discussionè¯·æ±‚å‡ºé”™: "+n):0!==t.data.code?(console.log("è®¨è®ºä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼šã€Ž"+t.message+"ã€\nè¯¦æƒ…è¯·æŸ¥çœ‹ï¼šhttps://shimo.im/docs/"+e),"error"):t.data}(o,content);return a.id=c.data.id,a.unixus=c.data.unixus,e.Cloud.run("save2LeanCloud",a),`${s=a.type,s.match(/[a-zA-Z]/g)?s.match(/mp4|mov|avi/gi)?"ðŸŽ¬":s.match(/webm|mkv|avi/gi)?"â–¶ï¸":s.match(/mp3|ogg|wav|flac|ape|alca|aac/gi)?"ðŸŽµ":s.match(/zip|7z|rar/gi)?"ðŸ“¦":s.match(/dmg|iso/gi)?"ðŸ’½":s.match(/ai|psd|aep/gi)?"ðŸ“":s.match(/ppt|pptx|key/gi)?"ðŸ“½ï¸":s.match(/ttf|otf/gi)?"ðŸ”¤ï¸":s.match(/doc|pdf/gi)?"ï¸ðŸ“„":"â“":s} ${a.name} | ${n=a.shortURL,n.replace(/[a-zA-z]+:\/\//g,"")}`}e.Cloud.define("updateShimo",async function(e){return await async function(e){var a;if(e&&0==e.params.code){var t=e.params.data;console.log("[1;31;47må·²ç»æˆåŠŸä¼ å…¥updateShimoè¿™é‡Œäº†[0m");var n=e.params.class||"ShimoBed",i={type:t.type,name:t.name,size:t.size,uploaderURL:t.url,lottieURL:e.params.lottieURL,chosenClass:n};m(i),a=[i]}else a=await p(o,s);return a}(e)});